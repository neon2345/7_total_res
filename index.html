<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人员路线分配展示</title>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=05274d5027e6b22978b2ade4630f3596"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .header h1 {
            font-size: 20px;
            margin-bottom: 10px;
        }
        
        .controls {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        
        .control-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }
        
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .personnel-info {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .info-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .info-item {
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-item strong {
            color: #555;
            display: inline-block;
            width: 80px;
        }
        
        .route-summary {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .route-summary .summary-item {
            display: inline-block;
            margin-right: 15px;
            font-size: 12px;
            color: #666;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .legend h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            margin-right: 8px;
            border-radius: 2px;
        }
        
        .route-within { background-color: #1890ff; }
        .route-between { background-color: #ff4d4f; }
        .route-store { background-color: #52c41a; }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>人员路线分配系统</h1>
                <p>选择人员和路线查看详细信息</p>
            </div>
            
            <div class="controls">
                <div class="control-group">
                    <label for="personnelSelect">选择人员：</label>
                    <select id="personnelSelect">
                        <option value="">请选择人员...</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="routeSelect">选择路线：</label>
                    <select id="routeSelect">
                        <option value="all">显示所有路线</option>
                    </select>
                </div>
            </div>
            
            <div class="personnel-info">
                <div id="personnelDetails">
                    <div class="loading">请选择人员查看详细信息</div>
                </div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="map"></div>
            <div class="legend">
                <h4>图例</h4>
                <div class="legend-item">
                    <div class="legend-color route-within"></div>
                    <span>路线内连线</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color route-between"></div>
                    <span>路线间连线</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color route-store"></div>
                    <span>门店位置</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let personnelData = [];
        let currentPersonnel = null;
        let routePolylines = [];
        let routeMarkers = [];
        
        // 初始化地图
        function initMap() {
            map = new AMap.Map('map', {
                center: [116.397428, 39.90923],
                zoom: 6,
                mapStyle: 'amap://styles/normal'
            });
            
            // 添加地图控件
            AMap.plugin(['AMap.Scale', 'AMap.ToolBar'], function() {
                map.addControl(new AMap.Scale());
                map.addControl(new AMap.ToolBar());
            });
        }
        
        // 加载人员数据
        async function loadPersonnelData() {
            try {
                const response = await fetch('personnel_route_combined_2025-07-01.json');
                const data = await response.json();
                personnelData = data.personnel_route_assignments;
                populatePersonnelSelect();
            } catch (error) {
                console.error('Error loading personnel data:', error);
                document.getElementById('personnelDetails').innerHTML = 
                    '<div class="loading">数据加载失败，请检查文件是否存在</div>';
            }
        }
        
        // 填充人员选择下拉框
        function populatePersonnelSelect() {
            const select = document.getElementById('personnelSelect');
            select.innerHTML = '<option value="">请选择人员...</option>';
            
            personnelData.forEach(person => {
                const option = document.createElement('option');
                option.value = person.personnel_id;
                option.textContent = `${person.name} (${person.personnel_id})`;
                select.appendChild(option);
            });
        }
        
        // 填充路线选择下拉框
        function populateRouteSelect(person) {
            const select = document.getElementById('routeSelect');
            select.innerHTML = '<option value="all">显示所有路线</option>';
            
            if (person && person.assigned_routes) {
                person.assigned_routes.forEach(route => {
                    const option = document.createElement('option');
                    option.value = route.route_id;
                    option.textContent = `路线 ${route.route_id} (${route.store_count}个门店)`;
                    select.appendChild(option);
                });
            }
        }
        
        // 显示人员详细信息
        function displayPersonnelInfo(person, selectedRouteId = 'all') {
            const container = document.getElementById('personnelDetails');
            
            if (!person) {
                container.innerHTML = '<div class="loading">请选择人员查看详细信息</div>';
                return;
            }
            
            const routeColors = ['#1890ff', '#52c41a', '#fa8c16', '#eb2f96', '#722ed1', '#13c2c2'];
            
            const html = `
                <div class="info-card">
                    <h3>基本信息</h3>
                    <div class="info-item"><strong>姓名:</strong> ${person.name}</div>
                    <div class="info-item"><strong>编号:</strong> ${person.personnel_id}</div>
                    <div class="info-item"><strong>工作天数:</strong> ${person.work_day}天</div>
                    <div class="info-item"><strong>效率:</strong> ${person.efficiency}</div>
                    <div class="info-item"><strong>禁止信息:</strong> ${person.ban_info || '无'}</div>
                    <div class="info-item"><strong>禁止城市:</strong> ${person.ban_city || '无'}</div>
                </div>
                
                <div class="info-card">
                    <h3>路线统计</h3>
                    <div class="route-summary">
                        <div class="summary-item"><strong>总路线数:</strong> ${person.route_summary.total_routes}</div>
                        <div class="summary-item"><strong>总门店数:</strong> ${person.route_summary.total_stores}</div>
                        <div class="summary-item"><strong>总距离:</strong> ${person.route_summary.total_distance_km.toFixed(1)}km</div>
                        <div class="summary-item"><strong>总时间(门店间移动+到店稽核):</strong> ${person.route_summary.total_time_h.toFixed(1)}h</div>
                        <div class="summary-item"><strong>总城市数:</strong> ${person.total_cities}</div>
                        <div class="summary-item"><strong>城市序列:</strong> ${person.city_sequence}</div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h3>路线详情</h3>
                    ${person.assigned_routes.map((route, index) => {
                        const color = routeColors[index % routeColors.length];
                        const isSelected = selectedRouteId != 'all' && route.route_id == selectedRouteId;
                        const backgroundStyle = isSelected ? `background: linear-gradient(135deg, ${color}15, ${color}25);` : 'background: white;';
                        const borderStyle = isSelected ? `border: 2px solid ${color};` : `border-left: 4px solid ${color};`;
                        
                        return `
                            <div style="margin-bottom: 10px; padding: 8px; ${backgroundStyle} border-radius: 4px; ${borderStyle} position: relative; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; margin-bottom: 4px;">
                                    <div style="width: 16px; height: 16px; background: ${color}; border-radius: 50%; margin-right: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: bold;">${index + 1}</div>
                                    <div style="font-weight: 500; color: ${color};">路线 ${route.route_id}</div>
                                    ${isSelected ? '<div style="margin-left: auto; color: ' + color + '; font-size: 12px; font-weight: bold;">● 当前选中</div>' : ''}
                                </div>
                                <div style="font-size: 12px; color: #666; margin-left: 24px;">
                                    ${route.store_count}个门店 | ${route.total_distance_km}km | ${route.total_time_h}h
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // 清除地图上的路线和标记
        function clearMapElements() {
            routePolylines.forEach(polyline => map.remove(polyline));
            routeMarkers.forEach(marker => map.remove(marker));
            routePolylines = [];
            routeMarkers = [];
        }
        
        // 在地图上显示路线
        function displayRoutes(person, selectedRouteId = 'all') {
            clearMapElements();
            
            if (!person || !person.assigned_routes) return;
            
            const routesToShow = selectedRouteId === 'all' 
                ? person.assigned_routes 
                : person.assigned_routes.filter(route => route.route_id == selectedRouteId);
            
            let allStores = [];
            const routeColors = ['#1890ff', '#52c41a', '#fa8c16', '#eb2f96', '#722ed1', '#13c2c2'];
            
            routesToShow.forEach((route, routeIndex) => {
                if (!route.stores || route.stores.length === 0) return;
                
                const color = routeColors[routeIndex % routeColors.length];
                
                // 添加门店标记
                route.stores.forEach((store, storeIndex) => {
                    const marker = new AMap.Marker({
                        position: [store.lon, store.lat],
                        title: store.name,
                        content: `<div style="background: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${storeIndex + 1}</div>`
                    });
                    
                    marker.setMap(map);
                    routeMarkers.push(marker);
                    
                    // 添加信息窗口
                    const infoWindow = new AMap.InfoWindow({
                        content: `
                            <div style="padding: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #333;">${store.name}</h4>
                                <p style="margin: 0; font-size: 12px; color: #666;">
                                    路线 ${route.route_id} - 第 ${storeIndex + 1} 站<br>
                                    经度: ${store.lon}<br>
                                    纬度: ${store.lat}
                                </p>
                            </div>
                        `
                    });
                    
                    marker.on('click', function() {
                        infoWindow.open(map, marker.getPosition());
                    });
                });
                
                // 绘制路线内连线
                if (route.stores.length > 1) {
                    const path = route.stores.map(store => [store.lon, store.lat]);
                    const polyline = new AMap.Polyline({
                        path: path,
                        strokeColor: color,
                        strokeWeight: 3,
                        strokeOpacity: 0.8,
                        strokeStyle: 'solid'
                    });
                    
                    polyline.setMap(map);
                    routePolylines.push(polyline);
                }
                
                allStores.push(...route.stores);
            });
            
            // 绘制路线间连线（如果显示所有路线）
            if (selectedRouteId === 'all' && routesToShow.length > 1) {
                for (let i = 0; i < routesToShow.length - 1; i++) {
                    const currentRoute = routesToShow[i];
                    const nextRoute = routesToShow[i + 1];
                    
                    if (currentRoute.stores.length > 0 && nextRoute.stores.length > 0) {
                        const lastStore = currentRoute.stores[currentRoute.stores.length - 1];
                        const firstStore = nextRoute.stores[0];
                        
                        const polyline = new AMap.Polyline({
                            path: [[lastStore.lon, lastStore.lat], [firstStore.lon, firstStore.lat]],
                            strokeColor: '#ff4d4f',
                            strokeWeight: 2,
                            strokeOpacity: 0.6,
                            strokeStyle: 'dashed'
                        });
                        
                        polyline.setMap(map);
                        routePolylines.push(polyline);
                    }
                }
            }
            
            // 调整地图视野到人员路线中心
            if (allStores.length > 0) {
                const bounds = new AMap.Bounds();
                allStores.forEach(store => {
                    bounds.extend([store.lon, store.lat]);
                });
                
                // 设置合适的边距，确保路线完全可见
                const padding = [50, 50, 50, 50]; // 上、右、下、左的边距
                map.setBounds(bounds, false, padding);
                
                // 如果只有一个门店，设置合适的缩放级别
                if (allStores.length === 1) {
                    map.setZoomAndCenter(12, [allStores[0].lon, allStores[0].lat]);
                }
            }
        }
        
        // 事件监听
        document.getElementById('personnelSelect').addEventListener('change', function() {
            const personnelId = this.value;
            
            if (personnelId) {
                currentPersonnel = personnelData.find(p => p.personnel_id === personnelId);
                populateRouteSelect(currentPersonnel);
                displayPersonnelInfo(currentPersonnel, 'all');
                displayRoutes(currentPersonnel);
            } else {
                currentPersonnel = null;
                populateRouteSelect(null);
                displayPersonnelInfo(null);
                clearMapElements();
            }
        });
        
        document.getElementById('routeSelect').addEventListener('change', function() {
            const routeId = this.value;
            if (currentPersonnel) {
                displayPersonnelInfo(currentPersonnel, routeId);
                displayRoutes(currentPersonnel, routeId);
            }
        });
        
        // 页面加载完成后初始化
        window.onload = function() {
            initMap();
            loadPersonnelData();
        };
    </script>
</body>
</html> 
